<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel='stylesheet', href='/stylesheets/jobs.css' />
    <script src="/jsDic/ajax.js"></script>
    <script src="/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js" ></script>
    <title>职位详情</title>
</head>
<body>
<nav>
    <b style="background-color: #00d6b2;width: 60px;height: 30px;color: white;font-size: 18px" onclick="backMain()">返回首页</b>
    <a style="background-color: #00d6b2;width: 60px;height: 30px;color: white;font-size: 18px" onclick="backJobList()">职位列表</a>
</nav>
<h1>职位管理</h1>
<div>
    <div class="cellBackSty">
        <b class="titleSty" id="10">企业图片:</b>
        <b style="font-size: 30px;color: red">(为保证照片质量,请先裁剪图片为1:1后上传)</b>
        <img class="imgSty"  id="1-10"/>
        <input type="file" onchange="selectImage(this)"/>
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="0">职位名称:  </b>
        <input type="text" placeholder="请输入公司名称" onblur="endEdit(this.value,0)" id="1-0"/>
    </div>
    <div class="cellBackSty">
        <p class="titleSty" id="1">公司描述:  </p>
        <textarea class="textAreSty"  placeholder="请输入公司简介(不超过5000字符 [注]:每个汉字计算为一个字符,空格以及标点符号计算在内)" onblur="endEdit(this.value,1)" id="1-1"></textarea>
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="2">公司名称:  </b>
        <input type="text" placeholder="请输入职位名称" onblur="endEdit(this.value,2)" id="1-2"/>
    </div>
    <div class="cellBackSty">
        <p class="titleSty" id="3">职位描述:  </p>
        <textarea class="textAreSty" placeholder="请输入职位描述(不超过5000字符 [注]:每个汉字计算为一个字符,空格以及标点符号计算在内)" onblur="endEdit(this.value,3)" id="1-3"></textarea>
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="4">最低学历要求:  </b>
        <select onchange="selectChanged(this.value,4)" id="1-4"></select>
        <!--<input type="text" placeholder="请输入最低学历要求" onblur="endEdit(this.value,4)" id="1-4"/>-->
    </div>
    <div class="cellBackSty">
         <b class="titleSty" id="12">最低工作年限要求:  </b>
        <select onchange="selectChanged(this.value,12)" id="1-12"></select>
        <!--<input type="text" placeholder="请输入最低工作年限要求" onblur="endEdit(this.value,12)" id="1-12"/>-->
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="5">公司地址(请输入公司的市-区):  </b>
        <input type="text" placeholder="请输入公司地址(如:合肥市-蜀山区)" onblur="endEdit(this.value,5)" id="1-5"/>
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="6">工作地点:  </b>
        <input type="text" placeholder="请输入作地点" onblur="endEdit(this.value,6)" id="1-6" style="width:250px"/>
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="7">面试地点:  </b>
        <input type="text" placeholder="请输入面试地点" onblur="endEdit(this.value,7)" id="1-7" style="width:250px"/>
    </div>
    <div class="cellBackSty">
         <b class="titleSty" id="13">面试截止日期:  </b>
        <input id="1-13" type="date" onblur="endEdit(this.value,13)"/>
         <!--<input type="text" placeholder="请输入面试地截止日期:(如05-08 上午)" style="width: 280px" onblur="endEdit(this.value,13)" id="1-13"/>-->
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="8">薪资范围:  </b>
        <select onchange="selectChanged(this.value,8)" id="1-8"></select>
        <!--<input type="text" placeholder="请输入薪资范围" onblur="endEdit(this.value,8)" id="1-8"/>-->
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="9">公司福利:  </b>
        <b style="margin-left: 20px;color: green" id="1-9"></b>
        <div id ='wellArrId' class="wellArrDivSty"></div>
    </div>
    <div class="cellBackSty">
        <b class="titleSty" id="11">默认申请人数(最终显示的申请人数=默认申请人数+真实申请人数):  </b>
        <input type="text" placeholder="请输入默认申请人数" onblur="endEdit(this.value,11)" id="1-11"/>
    </div>
    <div class="cellBackSty">
        <p class="titleSty" id="14">职位标签(请输入职位标签,当前仅仅支持单个标签,如:热招中);此选项可以为空建议只针对某些职位设置:  </p>
        <input type="text" style="width: 300px" placeholder="请输入标签,不能超过4个中文汉字;如:报名中、热招中" onblur="endEdit(this.value,14)" id="1-14"/>
    </div>
    <div class="cellBackSty">
        <p class="titleSty" id="15">职位图标,选择default表示默认图标,此选项可以为空,为保证小程序界面效果,请不要对超过三个以上的职位配置图标 </p>
        <select onchange="selectChanged(this.value,15)" id="1-15"></select>
    </div>
    <div class="cellBackSty">
        <p class="titleSty" style="font-size: 36px" id="16">所属开放城市(默认合肥) </p>
        <select onchange="selectChanged(this.value,16)" id="1-16"></select>
    </div>
    <button style="font-size: 24px;margin-left: 100px;margin-top: 20px;" onclick="subMit()">提交</button>
</div>
<script type="text/javascript">
    var administratorId ='';
    var defwellArr = [];
    var defDopArr =[];
    var defWorkyearsArr =[];
    var defIncomArr =[];
    var openCitysArr = [];
    var json = '<%-JSON.stringify(obj)%>';
    var jsonDic = JSON.parse(json);

    var dataArr = [];
    dataArr[17] = '';
    dataArr[9] = []
    getConfigData(function (value) {
        console.log('#####');
        if(jsonDic){
            handelData();
            administratorId = jsonDic.administratorId;
        }else {
            var a_ = GetRequest();
            administratorId = a_['administratorId'];

        }
    });

    /*获取配置*/
    function getConfigData(callback) {
        ajax({
            method:'POST',
            url:baseUrl+'config/config',
            data:{type:0},
            success:function (res) {
                var obj = JSON.parse(res);
                callback(1);
                if(obj.code ==0){
                    for (var  i=0; i<obj.data.length;i ++){
                        var dic = obj.data[i];
                        if (dic.configName =='well'){
                            defwellArr = dic.configValue.split("/");
                        }else if (dic.configName =='dop'){
                            defDopArr = dic.configValue.split("/");
                        }else if (dic.configName =='incom'){
                            defIncomArr = dic.configValue.split("/");
                        }else if (dic.configName =='workYears'){
                            defWorkyearsArr=dic.configValue.split("/");
                        }else if(dic.configName =='opencCitys'){
                            openCitysArr = dic.configValue.split("/");
                        }
                    }
                    createSelect();
                    createWellCell();
                    if(json && json.length >10){
                        for(var i =0;i <jsonDic.wellArr.length;i ++){
                            wellChooesd(jsonDic.wellArr[i],true);
                        }
                    }
                }else {
                    alert(obj.msg);
                }
            },
            fail:function (err) {
                callback(0)
            }
        })
    }

    function handelData() {
        dataArr[0] = jsonDic.companyName;
        dataArr[1] = jsonDic.companyDescrie;
        dataArr[2] = jsonDic.jobName;
        dataArr[3] = jsonDic.jobDescribe;
        dataArr[4] = jsonDic.minEducation;
        dataArr[5] = jsonDic.workAddress;
        dataArr[6] = jsonDic.workAddress;
        dataArr[7] = jsonDic.interViewAddress;
        dataArr[8] = jsonDic.salary;
        dataArr[9] = jsonDic.wellArr;
        dataArr[10] = jsonDic.companyImgUrl;
        dataArr[11] = jsonDic.defApplyNum;
        dataArr[12] = jsonDic.minWorkExperience;
        dataArr[13] = jsonDic.interviewTimes;
        dataArr[14] = jsonDic.statusTag;
        dataArr[15] = jsonDic.tagImgAddress;
        dataArr[16] = jsonDic.openCity;
        for(var i = 0; i <dataArr.length -1;i ++){
            endEdit(dataArr[i],i);
            var htmlId = '1-' +i;
            var html_ = document.getElementById(htmlId);
            if (i == 10){
                html_.style.backgroundImage = "url('" +dataArr[i] +"')";
                html_.style.backgroundSize = 'cover'
            }else if(i == 9){
                html_.innerHTML = dataArr[i];
            }else {
                html_.value = dataArr[i];
            }
        }
    }

    function endEdit(e,index) {
        if(e && e.length >0 || ((typeof e) == 'number')&& e>0){
            classChanged(index,true)
        }else {
            classChanged(index,false)
        }
        dataArr[index]  = e;
    }
    function classChanged(index,IsAdjective) {
        var title = document.getElementById(index);
        title.style.color = IsAdjective?'green':'red';
    }

    function createWellCell() {
        var div = document.getElementById('wellArrId')
        for(var i =0;i <defwellArr.length; i ++){
            var cell = document.createElement('button');
            cell.innerHTML = defwellArr[i];
            cell.style.margin = '10px';
            cell.setAttribute('id',defwellArr[i]);
            div.appendChild(cell);
            cell.onclick = function () {
                if(this.style.borderWidth == '1px'){
                    wellChooesd(this.id,true);
                    var index = dataArr[9].indexOf(this.id);
                    if(index <0){
                        dataArr[9].push(this.id);
                    }
                }else {
                    wellChooesd(this.id,false);
                    var index = dataArr[9].indexOf(this.id);
                    if(index >-1){
                        dataArr[9].splice(index,1);
                    }
                }
                var wellStr = document.getElementById('1-9');
                wellStr.innerHTML = dataArr[9];
                if(dataArr[9].length == 0){
                    classChanged(9,false);
                }else {
                    classChanged(9,true);
                }
            }
            wellChooesd(defwellArr[i],false)
        }
    }

    function wellChooesd(btnId,isChooesd) {
        var wellBtn = document.getElementById(btnId);
        if (wellBtn){
            if(isChooesd){
                wellBtn.style.borderColor = 'green';
                wellBtn.style.color = 'green'
                wellBtn.style.borderWidth = '2px'
                wellBtn.style.backgroundColor = '#db8621'
            }else {
                wellBtn.style.borderColor = '#999999';
                wellBtn.style.color = '#999999'
                wellBtn.style.borderWidth = '1px'
                wellBtn.style.backgroundColor = 'white'
            }
        }
    }

    function repalceHtml(str){
        var dd=str.replace(/<\/?.+?>%/g,"");
        var dds=dd.replace(/ /g,"");//dds为得到后的内容
        var value_ = dds.replace(/%/g,"%25");
        return value_;
    }

    /*计算字符长度*/
    jmz_GetLength = function(str) {
        return str.replace(/[\u0391-\uFFE5]/g,"aa").length;  //先把中文替换成两个字节的英文，在计算长度
    };

    function replacePoint(str) {
        return str.replace(/%/g,"%25");
    }

    function subMit() {
        var alertStr = '';
        for(var i=0;i <dataArr.length -1;i ++){
            if(i== 14 || i== 15){

            }else {
                if(!dataArr[i] ){
                    var title = document.getElementById(i);
                    var str = title.innerHTML;
                    str = str.substring(0,str.length -3);
                    alertStr = str+'不能为空';
                    break;
                }
            }
        }
        if(alertStr.length >0){
            alert(alertStr);
            return;
        }
        if(jmz_GetLength(dataArr[3]) >4500){
            alertStr = '职位描述不能超过5000字符'
        }else if(jmz_GetLength(dataArr[1]) >4500){
            alertStr = '企业描述不能超过5000字符'
        }

        if(alertStr.length >0){
            alert(alertStr);
            return;
        }
        var params = {
            companyName:dataArr[0],
            companyDescrie:repalceHtml(dataArr[1]),
            jobName:dataArr[2],
            jobDescribe:repalceHtml(dataArr[3]),
            minEducation:dataArr[4],
            workAddress:dataArr[5],
            interViewAddress:dataArr[7],
            salary:dataArr[8],
            wellArr:JSON.stringify(dataArr[9]),
            companyImgUrl:replacePoint(dataArr[10]),
            defApplyNum:dataArr[11],
            minWorkExperience:dataArr[12],
            interviewTimes:dataArr[13],
            statusTag:dataArr[14],
            administratorId:administratorId,
            type:1,
            openCity:dataArr[16]
        }
        if(jsonDic && jsonDic.jobId){
            params['jobId'] = jsonDic.jobId;
        }
        if(dataArr[15] && dataArr[15] != 0){
            params.tagImgAddress = dataArr[15];
        }else {
            params.tagImgAddress = null;
        }
        console.log(params)

        ajax({
            method:'POST',
            url:baseUrl+'jobs/jobDetail',
            data:params,
            success:function (res) {
                var obj = JSON.parse(res);
                console.log(obj)
                if(obj.code ==0){
                  //  alert(obj.msg)
                    setTimeout(function () {
                        window.location.href = baseUrl+'admin/joblist?administratorId='+administratorId;
                    },1500)
                }else {
                    alert(obj.msg);
                }
            }
        })
    }

    /*动态添加下拉选择框内容*/
    function createSelect() {
        var  dopArr = defDopArr;// ['不限','小学','初中','高中','本科','硕士']
        var selectDiv_xl = document.getElementById('1-4');
        for(var i=0;i <dopArr.length;i ++){
           var option = document.createElement('option');
            option.value = dopArr[i]
            option.innerHTML=dopArr[i]
            selectDiv_xl.appendChild(option);
        }

        var selectDiv_money = document.getElementById('1-8');

        var moneyArr = defIncomArr;//['1000~3000','3000~5000','5000~8000','8000~12000','12000~15000','15000以上']
        for(var i=0;i <moneyArr.length;i ++){
            var option = document.createElement('option');
            option.value = moneyArr[i]
            option.innerHTML=moneyArr[i]
            selectDiv_money.appendChild(option);
        }


        var selectDiv_workYears = document.getElementById('1-12');
        var workArr = defWorkyearsArr;//['不限','1年以内','1~3年','3~5年','5~10年','10年以上']
        for(var i=0;i <workArr.length;i ++){
            var option = document.createElement('option');
            option.value = workArr[i]
            option.innerHTML=workArr[i]
            selectDiv_workYears.appendChild(option);
        }

        var timeDiv = document.getElementById('1-13');
        console.log(CurentTime())
        timeDiv.value = CurentTime();
        timeDiv.min = CurentTime();


        var selectDiv_tagImgAddress = document.getElementById('1-15');
        var option_tagImg_d = document.createElement('option');
        option_tagImg_d.value = '0';
        option_tagImg_d.innerHTML='暂不展示图标';
        selectDiv_tagImgAddress.appendChild(option_tagImg_d);
        var option_tagImg = document.createElement('option');
        option_tagImg.value = 'default';
        option_tagImg.innerHTML='default';
        selectDiv_tagImgAddress.appendChild(option_tagImg);


        var opencitydiv = document.getElementById('1-16');
        for(var i=0;i <openCitysArr.length;i ++){
            var option = document.createElement('option');
            option.value = openCitysArr[i]
            option.innerHTML=openCitysArr[i]
            opencitydiv.appendChild(option);
        }


    }
    /*下拉框选择*/
   function selectChanged(e,index) {
       console.log(e,index);
       endEdit(e,index);
   }


    var image = '';
    function selectImage(file) {
        if (!file.files || !file.files[0]) {
            return;
        }
        var reader = new FileReader();
        reader.onload = function (evt) {
            document.getElementById('1-10').src = evt.target.result;
            image = evt.target.result;

        }
        reader.readAsDataURL(file.files[0]);
        var file__ = file.files[0];
        var cos = new COS({
            SecretId: 'AKID8A2iHgkzsa6QbfrFk3A5pOrpdIm47B0d',
            SecretKey: 'd63ueDbbQ4bwIf2SqKrKbhcLtJXdgqv1',
        })

        cos.sliceUploadFile({
            Bucket: 'goldbee-1256585845',
            Region: 'ap-chengdu',
            Key: file__.name,
            Body: file__ // 上传文件对象
//            onProgress: function(progressData) {
//                console.log(JSON.stringify(progressData));
//            }
        }, function(err, data) {
            console.log(data||err);
            if (data){
                dataArr[10]= 'https://'+data.Location;
                console.log(data.Location);
                endEdit(dataArr[10],10);
            }
        });
    }

    function CurentTime()
    {
        var now = new Date();

        var year = now.getFullYear();       //年
        var month = now.getMonth() + 1;     //月
        var day = now.getDate();            //日

        var clock = year + "-";

        if(month < 10)
            clock += "0";

        clock += month + "-";

        if(day < 10)
            clock += "0";

        clock += day + "";

        return(clock);
    }

    //.返回首页
    function backMain() {
        window.location.href = baseUrl+'admin/main?administratorId='+administratorId;
    }

    function backJobList() {
        window.location.href = baseUrl+'admin/joblist?administratorId='+administratorId;
    }

</script>
</body>
</html>